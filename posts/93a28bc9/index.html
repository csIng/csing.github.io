<!DOCTYPE html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<link rel="stylesheet" media="none">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ExoPlayer,缓冲,策略," />










<meta name="description" content="ExoPlayer是根据什么策略来缓冲媒体数据的？">
<meta name="keywords" content="ExoPlayer,缓冲,策略">
<meta property="og:type" content="article">
<meta property="og:title" content="ExoPlayer缓冲策略（三）">
<meta property="og:url" content="http://csing.github.com/posts/93a28bc9/index.html">
<meta property="og:site_name" content="csIng">
<meta property="og:description" content="ExoPlayer是根据什么策略来缓冲媒体数据的？">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-06-15T10:54:17.727Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ExoPlayer缓冲策略（三）">
<meta name="twitter:description" content="ExoPlayer是根据什么策略来缓冲媒体数据的？">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://csing.github.com/posts/93a28bc9/"/>





  <title>ExoPlayer缓冲策略（三） | csIng</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?01dea1732833758c8ef6f2bade1daf6f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">csIng</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://csing.github.com/posts/93a28bc9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="csIng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="csIng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ExoPlayer缓冲策略（三）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-14T12:07:47+08:00">
                2018-06-14
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-06-15T18:54:17+08:00">
                2018-06-15
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/93a28bc9/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/posts/93a28bc9/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ExoPlayer是根据什么策略来缓冲媒体数据的？</p>
<a id="more"></a>
<p>在之前的文章中我们描述过，<code>LoadControl</code>是控制媒体数据缓冲的，它有一个默认的实现<code>DefaulLoadControl</code>,默认的缓冲策略就在其中。</p>
<h3 id="默认参数信息"><a href="#默认参数信息" class="headerlink" title="默认参数信息"></a>默认参数信息</h3><p>缓冲策略控制需要基于一定的数据基础，根据数据来确定是否满足一定的条件（是否可以缓冲，是否可以播放等），以下是在<code>DefaultLoadControl</code>中定义的初始信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 播放开始后，播放器缓冲的最小缓冲时间。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MIN_BUFFER_MS = <span class="number">15000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放开始后，播放器缓冲的最大缓冲时间(DEFAULT_PRIORITIZE_TIME_OVER_SIZE_THRESHOLDS为true时)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_BUFFER_MS = <span class="number">50000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放前需缓冲的最小时间</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_BUFFER_FOR_PLAYBACK_MS = <span class="number">2500</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// rebuffer后播放器播放时需要缓冲的最小时间</span></span><br><span class="line"><span class="comment">// A rebuffer is defined to be caused by buffer depletion rather than a user action.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_BUFFER_FOR_PLAYBACK_AFTER_REBUFFER_MS = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认的缓冲大小，当设置为C.LENGTH_UNSET时，由加载控制器自动检测目标大小</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_TARGET_BUFFER_BYTES = C.LENGTH_UNSET;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓冲时间优先级是否大于缓冲大小优先级。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEFAULT_PRIORITIZE_TIME_OVER_SIZE_THRESHOLDS = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="默认加载控制器如何控制缓冲"><a href="#默认加载控制器如何控制缓冲" class="headerlink" title="默认加载控制器如何控制缓冲"></a>默认加载控制器如何控制缓冲</h3><h5 id="继续缓冲"><a href="#继续缓冲" class="headerlink" title="继续缓冲"></a>继续缓冲</h5><ol>
<li>当缓冲时间为高优先级时：<ul>
<li>未达到最小缓冲时间；</li>
</ul>
</li>
<li>当缓冲大小为高优先级时：<ul>
<li>未达到最小缓冲时间，并且未达到目标缓冲大小。</li>
</ul>
</li>
</ol>
<h5 id="停止缓冲"><a href="#停止缓冲" class="headerlink" title="停止缓冲"></a>停止缓冲</h5><ol>
<li>已缓冲时间超过了设置的最大缓冲时间；</li>
<li>超过最小缓冲时间：达到最大缓冲大小；</li>
<li>当设置了缓存大小为高优先级，即使未达到最小缓冲时间，但达到了最大缓冲大小。</li>
</ol>
<p>详细实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldContinueLoading</span><span class="params">(<span class="keyword">long</span> bufferedDurationUs, <span class="keyword">float</span> playbackSpeed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> targetBufferSizeReached = allocator.getTotalBytesAllocated() &gt;= targetBufferSize;</span><br><span class="line">    <span class="keyword">boolean</span> wasBuffering = isBuffering;</span><br><span class="line">    <span class="keyword">long</span> minBufferUs = <span class="keyword">this</span>.minBufferUs;</span><br><span class="line">    <span class="keyword">if</span> (playbackSpeed &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 当播放速率变大时，最小缓冲时间需要重新计算(Math.round((double) playoutDuration * speed);)</span></span><br><span class="line">        <span class="keyword">long</span> mediaDurationMinBufferUs =</span><br><span class="line">            Util.getMediaDurationForPlayoutDuration(minBufferUs, playbackSpeed);</span><br><span class="line">        minBufferUs = Math.min(mediaDurationMinBufferUs, maxBufferUs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断缓冲时间并根据优先级处理。</span></span><br><span class="line">    <span class="keyword">if</span> (bufferedDurationUs &lt; minBufferUs) &#123;</span><br><span class="line">        isBuffering = prioritizeTimeOverSizeThresholds || !targetBufferSizeReached;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufferedDurationUs &gt; maxBufferUs || targetBufferSizeReached) &#123;</span><br><span class="line">        <span class="comment">// 判断最大缓冲时间和目标缓冲大小。</span></span><br><span class="line">        isBuffering = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="comment">// Else don't change the buffering state</span></span><br><span class="line">    <span class="keyword">if</span> (priorityTaskManager != <span class="keyword">null</span> &amp;&amp; isBuffering != wasBuffering) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBuffering) &#123;</span><br><span class="line">            priorityTaskManager.add(C.PRIORITY_PLAYBACK);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            priorityTaskManager.remove(C.PRIORITY_PLAYBACK);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isBuffering;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="如何计算目标缓冲大小"><a href="#如何计算目标缓冲大小" class="headerlink" title="如何计算目标缓冲大小"></a>如何计算目标缓冲大小</h4><p>目标缓冲大小是判断是否继续缓冲的一个很重要的参数，它是如何计算的呢？</p>
<p>当设置了<code>DEFAULT_TARGET_BUFFER_BYTES = C.LENGTH_UNSET;</code> 需要计算期待达到的目标缓冲大小：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 轨道选择器准备就绪，调用此方法。</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTracksSelected</span><span class="params">(Renderer[] renderers, TrackGroupArray trackGroups,</span></span></span><br><span class="line"><span class="function"><span class="params">                             TrackSelectionArray trackSelections)</span> </span>&#123;</span><br><span class="line">    targetBufferSize =</span><br><span class="line">        targetBufferBytesOverwrite == C.LENGTH_UNSET</span><br><span class="line">            ? calculateTargetBufferSize(renderers, trackSelections)</span><br><span class="line">            : targetBufferBytesOverwrite;</span><br><span class="line">    allocator.setTargetBufferSize(targetBufferSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点在于<code>calculateTargetBufferSize</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Calculate target buffer size in bytes based on the selected tracks. The player will try not to</span></span><br><span class="line"><span class="comment">   * exceed this target buffer. Only used when &#123;<span class="doctag">@code</span> targetBufferBytes&#125; is &#123;<span class="doctag">@link</span> C#LENGTH_UNSET&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> renderers The renderers for which the track were selected.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> trackSelectionArray The selected tracks.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The target buffer size in bytes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">calculateTargetBufferSize</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Renderer[] renderers, TrackSelectionArray trackSelectionArray)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> targetBufferSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; renderers.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (trackSelectionArray.get(i) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetBufferSize += Util.getDefaultBufferSize(renderers[i].getTrackType());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> targetBufferSize;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Maps a &#123;<span class="doctag">@link</span> C&#125; &#123;<span class="doctag">@code</span> TRACK_TYPE_*&#125; constant to the corresponding &#123;<span class="doctag">@link</span> C&#125;</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@code</span> DEFAULT_*_BUFFER_SIZE&#125; constant.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> trackType The track type.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The corresponding default buffer size in bytes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultBufferSize</span><span class="params">(<span class="keyword">int</span> trackType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (trackType) &#123;</span><br><span class="line">        <span class="keyword">case</span> C.TRACK_TYPE_DEFAULT:</span><br><span class="line">            <span class="keyword">return</span> C.DEFAULT_MUXED_BUFFER_SIZE;</span><br><span class="line">        <span class="keyword">case</span> C.TRACK_TYPE_AUDIO:</span><br><span class="line">            <span class="keyword">return</span> C.DEFAULT_AUDIO_BUFFER_SIZE;</span><br><span class="line">        <span class="keyword">case</span> C.TRACK_TYPE_VIDEO:</span><br><span class="line">            <span class="keyword">return</span> C.DEFAULT_VIDEO_BUFFER_SIZE;</span><br><span class="line">        <span class="keyword">case</span> C.TRACK_TYPE_TEXT:</span><br><span class="line">            <span class="keyword">return</span> C.DEFAULT_TEXT_BUFFER_SIZE;</span><br><span class="line">        <span class="keyword">case</span> C.TRACK_TYPE_METADATA:</span><br><span class="line">            <span class="keyword">return</span> C.DEFAULT_METADATA_BUFFER_SIZE;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上可以看到，目标缓冲大小的计算其实是根据默认的视频缓冲区/音频缓冲区等来确定的。</p>
<h3 id="如何判断是否可以播放？"><a href="#如何判断是否可以播放？" class="headerlink" title="如何判断是否可以播放？"></a>如何判断是否可以播放？</h3><p>该功能由<code>shouldStartPlayback</code>来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldStartPlayback</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> bufferedDurationUs, <span class="keyword">float</span> playbackSpeed, <span class="keyword">boolean</span> rebuffering)</span> </span>&#123;</span><br><span class="line">    bufferedDurationUs = Util.getPlayoutDurationForMediaDuration(bufferedDurationUs, playbackSpeed);</span><br><span class="line">    <span class="keyword">long</span> minBufferDurationUs = rebuffering ? bufferForPlaybackAfterRebufferUs : bufferForPlaybackUs;</span><br><span class="line">    <span class="keyword">return</span> minBufferDurationUs &lt;= <span class="number">0</span></span><br><span class="line">        || bufferedDurationUs &gt;= minBufferDurationUs</span><br><span class="line">        || (!prioritizeTimeOverSizeThresholds</span><br><span class="line">            &amp;&amp; allocator.getTotalBytesAllocated() &gt;= targetBufferSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>满足的条件如下：</p>
<ol>
<li>最小缓冲时间小于等于0；</li>
<li>缓冲时间达到了设置的最小缓冲时间；</li>
<li>以缓冲大小为优先级时，当前缓冲大小已达到了设置的目标缓冲大小。</li>
</ol>
<p>综合以上，<code>LoadControl</code>控制器是针对缓冲和播放的策略控制；其主要根据缓冲时间和缓冲大小，并结合两者的优先级进行管理。另外在默认参数的设置上，根据该<a href="https://github.com/google/ExoPlayer/issues/2083" target="_blank" rel="noopener">链接</a>中的说明：</p>
<blockquote>
<p>There are arguments that mobile carriers prefer this kind of traffic pattern over their networks (i.e. bursts rather than drip-feeding). Which is an important consideration given ExoPlayer is used by some very popular services. It may also be more battery efficient.</p>
<p>Whether these arguments are still valid is something we should probably take another look at fairly soon, since the information we used when making this decision is 3-4 years old now. We should also figure out whether we should adjust the policy dynamically based on network type (e.g. even if the arguments are still valid, they may only hold for mobile networks and not for WiFi).</p>
<p>note：2016year.</p>
</blockquote>
<p>目前的参数设置应该根据网络类型及不同的场景动态设置。</p>
<p>在最近(20180309)的更新中,官方人员已将maxBuffered设置为50000ms，其commit说明如下：</p>
<blockquote>
<p>The value is increased to 50 seconds. With that the player can better handle short network problems. This does NOT increase the maximum memory used as we still apply the seperate DEFAULT_TARGET_BUFFER_BYTES.</p>
</blockquote>
<p>在以上的描述中，涉及到两个重要的方法<code>shouldContinueLoading</code>和<code>shouldStartPlayback</code>,它们是在什么样的场景下触发的？</p>
<h5 id="shouldContinueLoading的触发时机"><a href="#shouldContinueLoading的触发时机" class="headerlink" title="shouldContinueLoading的触发时机"></a><code>shouldContinueLoading</code>的触发时机</h5><p><code>shouldContinueLoading</code>的调用是在<code>ExoPlayerImplInternal</code>中；</p>
<ol>
<li>Period prepared/update;</li>
<li>Tracker reselcted;</li>
<li>Seek to target position;</li>
<li>Media source refresh.</li>
</ol>
<p>以上都是在播放器播放未结束的前提条件下。</p>
<h5 id="shouldStartPlayback的触发时机"><a href="#shouldStartPlayback的触发时机" class="headerlink" title="shouldStartPlayback的触发时机"></a><code>shouldStartPlayback</code>的触发时机</h5><p>在<code>ExoPlayerImplInternal</code>中的<code>doSomeWork()</code>时，<code>shouldStartPlayback</code>是播放器的状态从<code>STATE_BUFFERING</code>切换到<code>STATE_READY</code>时需满足的一个条件。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ExoPlayer/" <i class="fa fa-tag"></i> ExoPlayer</a>
          
            <a href="/tags/缓冲/" <i class="fa fa-tag"></i> 缓冲</a>
          
            <a href="/tags/策略/" <i class="fa fa-tag"></i> 策略</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/30146431/" rel="next" title="《无声告白》">
                <i class="fa fa-chevron-left"></i> 《无声告白》
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/d847228d/" rel="prev" title="APT简记">
                APT简记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">csIng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#默认参数信息"><span class="nav-number">1.</span> <span class="nav-text">默认参数信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认加载控制器如何控制缓冲"><span class="nav-number">2.</span> <span class="nav-text">默认加载控制器如何控制缓冲</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#继续缓冲"><span class="nav-number">2.0.1.</span> <span class="nav-text">继续缓冲</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#停止缓冲"><span class="nav-number">2.0.2.</span> <span class="nav-text">停止缓冲</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何计算目标缓冲大小"><span class="nav-number">2.1.</span> <span class="nav-text">如何计算目标缓冲大小</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何判断是否可以播放？"><span class="nav-number">3.</span> <span class="nav-text">如何判断是否可以播放？</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#shouldContinueLoading的触发时机"><span class="nav-number">3.0.1.</span> <span class="nav-text">shouldContinueLoading的触发时机</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#shouldStartPlayback的触发时机"><span class="nav-number">3.0.2.</span> <span class="nav-text">shouldStartPlayback的触发时机</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">csIng</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>







<span class="post-meta-divider">|</span>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_uv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span>人</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span>次</span>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: decodeURI(window.location.pathname), 
            owner: 'csing',
            repo: 'csing.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'fae098b5ef52379c4667befefc1b00a095c35914',
            
                client_id: 'd812722a8d91d0daee33'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
